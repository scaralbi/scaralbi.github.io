<!--This is a dumb hack that lets us use Hugo variables in our CSS.
    We can't use Hugo variables in CSS directly:
    <https://discourse.gohugo.io/t/how-to-use-hugo-template-variables-in-css/4464/13>
    So we have to place CSS here in HTML templates where we can use Hugo variables.
    -->

{{- if default true .Site.Params.OnionskinLinkAnnotations }}

<!--The BaseURL without a trailing slash-->
{{- $baseUrlStripped := substr .Site.BaseURL 0 -1 }}

<!--Onion link annotation
    Note that this is not foolproof --
    a URL like 'https://example.com/my.favorite.onion.html' will have this annotation applied by default.
    Don't rely on this for URLs from untrusted input (comments etc).
    For URLs from trusted input, you can always override with a .annotated-link-TYPE class.
    -->
{{- if .Site.Params.OnionskinLinkAnnotationOnionImage }}
{{- $onionAnnotationImage := resources.Get .Site.Params.OnionskinLinkAnnotationOnionImage }}
<style>
  a.annotated-link-onion:before,
  a[href*=".onion"]:not(:where(
    .no-link-annotation,
    .annotated-link-clearnet,
    .annotated-link-internal,
    .annotated-link-anchor,
  )):before
  {
    content: url('data:{{ $onionAnnotationImage.MediaType }};base64,{{ $onionAnnotationImage.Content | base64Encode | safeURL }}') " ";
  }
  </style>
{{- else if .Site.Params.OnionskinLinkAnnotationOnionString }}
<style>
  a.annotated-link-onion:before,
  a[href*=".onion"]:not(:where(
    .no-link-annotation,
    .annotated-link-clearnet,
    .annotated-link-internal,
    .annotated-link-anchor,
  )):before
  {
    content: "{{ .Site.Params.OnionskinLinkAnnotationOnionString }} ";
    font-size: 0.75em;
    vertical-align: top;
    color: var(--body-fg-color);
  }
</style>
{{- end }}


<!--Clearnet link annotation
    -->
{{- if .Site.Params.OnionskinLinkAnnotationClearnetImage }}
{{- $clearnetAnnotationImage := resources.Get .Site.Params.OnionskinLinkAnnotationClearnetImage }}
<style>
  a.annotated-link-clearnet:before,
  a[href*="//"]:not(:where(
    .no-link-annotation,
    .annotated-link-onion,
    .annotated-link-internal,
    .annotated-link-anchor,
    [href*=".onion"],
    {{ printf "[href*='%s']," .Site.BaseURL | safeCSS }}
  )):before
  {
    content: url('data:{{ $clearnetAnnotationImage.MediaType }};base64,{{ $clearnetAnnotationImage.Content | base64Encode | safeURL }}') " ";
  }
</style>
{{- else if .Site.Params.OnionskinLinkAnnotationClearnetString }}
<style>
  a.annotated-link-clearnet:before,
  a[href*="//"]:not(:where(
    .no-link-annotation,
    .annotated-link-onion,
    .annotated-link-internal,
    .annotated-link-anchor,
    [href*=".onion"],
    {{ printf "[href*='%s']," .Site.BaseURL | safeCSS }}
  )):before
  {
    content: "{{ .Site.Params.OnionskinLinkAnnotationClearnetString }} ";
    font-size: 0.75em;
    vertical-align: top;
    color: var(--body-fg-color);
  }
</style>
{{- end }}

<!--Internal link annotation
    -->
{{- if .Site.Params.OnionskinLinkAnnotationInternalImage }}
{{- $internalAnnotationImage := resources.Get .Site.Params.OnionskinLinkAnnotationInternalImage }}
<style>
  a.annotated-link-internal:before,
  a:not(:where(
    [href*='//'],
    [href^="#"],
    .no-link-annotation,
    .annotated-link-onion,
    .annotated-link-clearnet,
    .annotated-link-anchor,
  )):before,
  {{ printf "a[href*='%s']:not(:where(" $baseUrlStripped | safeCSS }}
    .no-link-annotation,
    .annotated-link-onion,
    .annotated-link-clearnet,
    .annotated-link-anchor,
  )):before
  {
    content: url('data:{{ $internalAnnotationImage.MediaType }};base64,{{ $internalAnnotationImage.Content | base64Encode | safeURL }}') " ";
  }
</style>
{{- else if .Site.Params.OnionskinLinkAnnotationInternalString }}
<style>
  a.annotated-link-internal:before,
  a:not(:where(
    [href*='//'],
    [href^="#"],
    .no-link-annotation,
    .annotated-link-onion,
    .annotated-link-clearnet,
    .annotated-link-anchor,
  )):before,
  {{ printf "a[href*='%s']:not(:where(" $baseUrlStripped | safeCSS }}
    .no-link-annotation,
    .annotated-link-onion,
    .annotated-link-clearnet,
    .annotated-link-anchor,
  )):before
  {
    content: "{{ .Site.Params.OnionskinLinkAnnotationInternalString }} ";
    font-size: 0.75em;
    vertical-align: top;
    color: var(--body-fg-color);
  }
  </style>
{{- end }}

<!--Anchor link annotation
    -->
{{- if .Site.Params.OnionskinLinkAnnotationAnchorImage }}
{{- $anchorAnnotationImage := resources.Get .Site.Params.OnionskinLinkAnnotationAnchorImage }}
<style>
  a.annotated-link-anchor:before,
  a[href^="#"]:not(:where(
    .no-link-annotation,
    .annotated-link-onion,
    .annotated-link-clearnet,
    .annotated-link-internal,
  )):before {
    content: url('data:{{ $anchorAnnotationImage.MediaType }};base64,{{ $anchorAnnotationImage.Content | base64Encode | safeURL }}') " ";
  }
</style>
{{- else if .Site.Params.OnionskinLinkAnnotationAnchorString }}
<style>
  a.annotated-link-anchor:before,
  a[href^="#"]:not(:where(
    .no-link-annotation,
    .annotated-link-onion,
    .annotated-link-clearnet,
    .annotated-link-internal,
  )):before {
    content: "{{ .Site.Params.OnionskinLinkAnnotationAnchorString }} ";
    font-size: 0.75em;
    vertical-align: top;
    color: var(--body-fg-color);
  }
</style>
{{- end }}

{{- end }}